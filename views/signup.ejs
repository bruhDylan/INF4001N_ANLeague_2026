<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - African Nations League</title>
  <link href="https://fonts.googleapis.com/css2?family=Aclonica&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 20px;
      color: #e0e0e0;
    }
    .signup-container { 
      background: rgba(15, 20, 40, 0.95); 
      padding: 40px; 
      border-radius: 12px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
      width: 100%; 
      max-width: 500px; 
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    h1 { 
      text-align: center; 
      margin-bottom: 30px; 
      color: #ffffff; 
      font-size: 2.2em;
      font-family: 'Aclonica', cursive;
      font-weight: 400;
      letter-spacing: 1px;
    }
    .form-group { 
      margin-bottom: 20px; 
    }
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      color: #b0b0b0; 
      font-weight: 600; 
      font-size: 0.95em;
    }
    .form-group input, .form-group select { 
      width: 100%; 
      padding: 12px; 
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 6px; 
      font-size: 16px; 
      color: #e0e0e0;
      transition: all 0.3s ease;
    }
    .form-group input:focus, .form-group select:focus { 
      outline: none; 
      border-color: #667eea; 
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    .form-group input::placeholder {
      color: #888;
    }
    .btn { 
      width: 100%; 
      padding: 14px; 
      background: #667eea; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      font-size: 16px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      margin-top: 10px;
    }
    .btn:hover { 
      background: #5568d3; 
      transform: translateY(-1px);
    }
    .btn:disabled { 
      background: rgba(102, 126, 234, 0.3); 
      color: #888;
      cursor: not-allowed; 
      transform: none;
    }
    .message { 
      margin-top: 15px; 
      padding: 12px; 
      border-radius: 6px; 
      text-align: center; 
      font-weight: 500;
    }
    .error { 
      background: rgba(220, 53, 69, 0.2); 
      color: #ff6b6b; 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    .success { 
      background: rgba(40, 167, 69, 0.2); 
      color: #4caf50; 
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    .link { 
      text-align: center; 
      margin-top: 20px; 
      color: #888;
    }
    .link a { 
      color: #667eea; 
      text-decoration: none; 
      font-weight: 500;
    }
    .link a:hover { 
      text-decoration: underline; 
      color: #7c8ff0;
    }
    .country-status { 
      margin-top: 5px; 
      font-size: 14px; 
      padding: 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .country-available { 
      background: rgba(40, 167, 69, 0.1);
      color: #4caf50; 
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    .country-taken { 
      background: rgba(220, 53, 69, 0.1);
      color: #ff6b6b; 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    .loading { 
      color: #888; 
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .warning-banner { 
      background: rgba(255, 193, 7, 0.1); 
      border: 1px solid rgba(255, 193, 7, 0.3); 
      color: #ffd700; 
      padding: 12px; 
      border-radius: 6px; 
      margin-bottom: 20px; 
      font-size: 14px; 
      text-align: center; 
      font-weight: 500; 
    }
    .success-banner {
      background: rgba(0, 123, 255, 0.1);
      border: 1px solid rgba(0, 123, 255, 0.3);
      color: #66b3ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
      font-weight: 500;
    }
    optgroup {
      font-weight: 600;
      color: #b0b0b0;
      background: rgba(30, 35, 55, 0.8);
    }
    option {
      font-weight: normal;
      background: rgba(15, 20, 40, 0.95);
      color: #e0e0e0;
    }
    option:disabled {
      color: #666;
      background: rgba(30, 35, 55, 0.6);
    }
    .countries-count {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #b0b0b0;
      font-weight: 500;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #20c997);
      transition: width 0.3s ease;
    }
    select {
      background: rgba(255, 255, 255, 0.05);
      color: #e0e0e0;
    }
    select option {
      background: rgba(15, 20, 40, 0.95);
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="signup-container">
    <h1>ANL TEAM REGISTRATION</h1>
    
    <div class="warning-banner">
      Only 8 countries available for registration
    </div>

    <div class="countries-count" id="countriesCount">
      Loading country availability...
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>

    <form id="signupForm">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" name="email" required placeholder="Enter your email">
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required placeholder="Create a password" minlength="6">
      </div>

      <div class="form-group">
        <label for="displayName">Your Name</label>
        <input type="text" id="displayName" name="displayName" required placeholder="Enter your full name">
      </div>

      <div class="form-group">
        <label for="country">Select Your Country</label>
        <select id="country" name="country" required onchange="checkCountryAvailability()">
          <option value="">Choose a country...</option>
          
          <!-- WEST AFRICA -->
          <optgroup label="West Africa">
            <option value="NGA">Nigeria</option>
            <option value="GHA">Ghana</option>
            <option value="CIV">Ivory Coast</option>
            <option value="SEN">Senegal</option>
            <option value="MLI">Mali</option>
            <option value="CMR">Cameroon</option>
            <option value="BFA">Burkina Faso</option>
            <option value="BEN">Benin</option>
            <option value="NER">Niger</option>
            <option value="TGO">Togo</option>
            <option value="GIN">Guinea</option>
            <option value="GNB">Guinea-Bissau</option>
            <option value="LBR">Liberia</option>
            <option value="SLE">Sierra Leone</option>
            <option value="CPV">Cape Verde</option>
          </optgroup>
          
          <!-- NORTH AFRICA -->
          <optgroup label="North Africa">
            <option value="EGY">Egypt</option>
            <option value="MAR">Morocco</option>
            <option value="DZA">Algeria</option>
            <option value="TUN">Tunisia</option>
            <option value="LBY">Libya</option>
            <option value="SDN">Sudan</option>
            <option value="MRT">Mauritania</option>
            <option value="ESH">Western Sahara</option>
          </optgroup>
          
          <!-- EAST AFRICA -->
          <optgroup label="East Africa">
            <option value="ETH">Ethiopia</option>
            <option value="KEN">Kenya</option>
            <option value="UGA">Uganda</option>
            <option value="TZA">Tanzania</option>
            <option value="RWA">Rwanda</option>
            <option value="BDI">Burundi</option>
            <option value="SSD">South Sudan</option>
            <option value="SOM">Somalia</option>
            <option value="DJI">Djibouti</option>
            <option value="ERI">Eritrea</option>
          </optgroup>
          
          <!-- SOUTH AFRICA -->
          <optgroup label="South Africa">
            <option value="ZAF">South Africa</option>
            <option value="ZWE">Zimbabwe</option>
            <option value="ZMB">Zambia</option>
            <option value="BWA">Botswana</option>
            <option value="NAM">Namibia</option>
            <option value="MOZ">Mozambique</option>
            <option value="AGO">Angola</option>
            <option value="SWZ">Eswatini</option>
            <option value="LSO">Lesotho</option>
            <option value="MWI">Malawi</option>
          </optgroup>
          
          <!-- CENTRAL AFRICA -->
          <optgroup label="Central Africa">
            <option value="COD">DR Congo</option>
            <option value="COG">Congo</option>
            <option value="GAB">Gabon</option>
            <option value="TCD">Chad</option>
            <option value="CAF">Central African Republic</option>
            <option value="GNQ">Equatorial Guinea</option>
          </optgroup>
        </select>
        <div id="countryStatus" class="country-status"></div>
      </div>

      <div class="form-group">
        <label for="managerName">Team Manager Name</label>
        <input type="text" id="managerName" name="managerName" required placeholder="Enter manager's name">
      </div>

      <button type="submit" class="btn" id="submitBtn">Register Team</button>
      <div id="message"></div>
    </form>

    <div class="link">
      Already have an account? <a href="/login">Login here</a>
    </div>
    <div class="link">
      <a href="/">Back to Home</a>
    </div>
  </div>

  <script>
    let takenCountries = [];
    const MAX_COUNTRIES = 8;

    // Country code to name mapping
    const countryCodeToName = {
      'NGA': 'Nigeria', 'GHA': 'Ghana', 'CIV': 'Ivory Coast', 'SEN': 'Senegal', 'MLI': 'Mali',
      'CMR': 'Cameroon', 'BFA': 'Burkina Faso', 'BEN': 'Benin', 'NER': 'Niger', 'TGO': 'Togo',
      'GIN': 'Guinea', 'GNB': 'Guinea-Bissau', 'LBR': 'Liberia', 'SLE': 'Sierra Leone', 'CPV': 'Cape Verde',
      'EGY': 'Egypt', 'MAR': 'Morocco', 'DZA': 'Algeria', 'TUN': 'Tunisia', 'LBY': 'Libya',
      'SDN': 'Sudan', 'MRT': 'Mauritania', 'ESH': 'Western Sahara',
      'ETH': 'Ethiopia', 'KEN': 'Kenya', 'UGA': 'Uganda', 'TZA': 'Tanzania', 'RWA': 'Rwanda',
      'BDI': 'Burundi', 'SSD': 'South Sudan', 'SOM': 'Somalia', 'DJI': 'Djibouti', 'ERI': 'Eritrea',
      'ZAF': 'South Africa', 'ZWE': 'Zimbabwe', 'ZMB': 'Zambia', 'BWA': 'Botswana', 'NAM': 'Namibia',
      'MOZ': 'Mozambique', 'AGO': 'Angola', 'SWZ': 'Eswatini', 'LSO': 'Lesotho', 'MWI': 'Malawi',
      'COD': 'DR Congo', 'COG': 'Congo', 'GAB': 'Gabon', 'TCD': 'Chad', 'CAF': 'Central African Republic', 'GNQ': 'Equatorial Guinea'
    };

    // Update progress bar and count display
    function updateProgressBar() {
      const progressFill = document.getElementById('progressFill');
      const countriesCount = document.getElementById('countriesCount');
      const percentage = (takenCountries.length / MAX_COUNTRIES) * 100;
      
      progressFill.style.width = `${percentage}%`;
      
      if (takenCountries.length >= MAX_COUNTRIES) {
        countriesCount.innerHTML = `<strong>All ${MAX_COUNTRIES} countries have been registered</strong>`;
        countriesCount.style.color = '#ff6b6b';
      } else {
        countriesCount.innerHTML = `<strong>${takenCountries.length}/${MAX_COUNTRIES}</strong> countries registered`;
        countriesCount.style.color = '#4caf50';
      }
    }

    // Load taken countries on page load
    async function loadTakenCountries() {
      try {
        const countriesCount = document.getElementById('countriesCount');
        countriesCount.innerHTML = 'Loading country availability...';
        
        const response = await fetch('/api/auth/taken-countries');
        const data = await response.json();
        
        if (data.success) {
          takenCountries = data.takenCountries || [];
          console.log('Taken country codes:', takenCountries);
          console.log(`${takenCountries.length}/${MAX_COUNTRIES} countries registered`);
          
          updateProgressBar();
        } else {
          console.error('Failed to load taken countries:', data.error);
          countriesCount.innerHTML = 'Error loading country data';
          countriesCount.style.color = '#ff6b6b';
        }
      } catch (error) {
        console.error('Error loading taken countries:', error);
        document.getElementById('countriesCount').innerHTML = 'Error loading country data';
        document.getElementById('countriesCount').style.color = '#ff6b6b';
      }
    }

    // Check if a country is available
    async function checkCountryAvailability() {
      const countrySelect = document.getElementById('country');
      const countryStatus = document.getElementById('countryStatus');
      const submitBtn = document.getElementById('submitBtn');
      const selectedCountryCode = countrySelect.value;

      if (!selectedCountryCode) {
        countryStatus.textContent = '';
        countryStatus.className = 'country-status';
        submitBtn.disabled = false;
        return;
      }

      const selectedCountryName = countryCodeToName[selectedCountryCode] || selectedCountryCode;
      countryStatus.textContent = `Checking ${selectedCountryName}...`;
      countryStatus.className = 'country-status loading';

      try {
        // Check if max countries reached
        if (takenCountries.length >= MAX_COUNTRIES) {
          countryStatus.textContent = 'All countries are registered. Registration closed.';
          countryStatus.className = 'country-status country-taken';
          submitBtn.disabled = true;
          return;
        }

        // Check if country is already taken
        if (takenCountries.includes(selectedCountryCode)) {
          countryStatus.textContent = `${selectedCountryName} is already registered`;
          countryStatus.className = 'country-status country-taken';
          submitBtn.disabled = true;
        } else {
          countryStatus.textContent = `${selectedCountryName} is available! (${takenCountries.length}/${MAX_COUNTRIES} taken)`;
          countryStatus.className = 'country-status country-available';
          submitBtn.disabled = false;
        }
      } catch (error) {
        countryStatus.textContent = 'Unable to check availability';
        countryStatus.className = 'country-status';
        submitBtn.disabled = false;
        console.error('Error checking country availability:', error);
      }
    }

    // Update country options to show taken countries as disabled
    function updateCountryOptions() {
      const countrySelect = document.getElementById('country');
      const options = countrySelect.querySelectorAll('option');
      
      options.forEach(option => {
        if (option.value && takenCountries.includes(option.value)) {
          option.disabled = true;
          option.textContent += ' - Taken';
        } else if (option.value) {
          option.disabled = false;
          // Remove any existing "Taken" text
          option.textContent = option.textContent.replace(' - Taken', '');
        }
      });

      // Disable all options if max countries reached
      if (takenCountries.length >= MAX_COUNTRIES) {
        options.forEach(option => {
          if (option.value) {
            option.disabled = true;
            if (!option.textContent.includes('Taken')) {
              option.textContent += ' - Registration Closed';
            }
          }
        });
      }
    }

    // Handle form submission
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const countryCode = document.getElementById('country').value;
      const countryName = countryCodeToName[countryCode];
      
      const formData = {
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        displayName: document.getElementById('displayName').value,
        countryCode: countryCode,
        countryName: countryName,
        managerName: document.getElementById('managerName').value
      };
      
      const messageDiv = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');
      
      // Validate form
      if (!formData.email || !formData.password || !formData.displayName || !formData.countryCode || !formData.managerName) {
        messageDiv.textContent = 'Please fill in all fields';
        messageDiv.className = 'message error';
        return;
      }

      if (formData.password.length < 6) {
        messageDiv.textContent = 'Password must be at least 6 characters';
        messageDiv.className = 'message error';
        return;
      }

      // Check if max countries reached
      if (takenCountries.length >= MAX_COUNTRIES) {
        messageDiv.textContent = 'Maximum countries reached. Registration is closed.';
        messageDiv.className = 'message error';
        return;
      }

      // Double-check country availability before submitting
      if (takenCountries.includes(countryCode)) {
        messageDiv.textContent = 'This country is already taken. Please choose another country.';
        messageDiv.className = 'message error';
        return;
      }
      
      messageDiv.textContent = 'Registering team...';
      messageDiv.className = 'message';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';
      
      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageDiv.textContent = 'Registration successful! Redirecting to team dashboard...';
          messageDiv.className = 'message success';
          
          // Store user data
          localStorage.setItem('user', JSON.stringify(data.user));
          
          // Refresh taken countries list
          await loadTakenCountries();
          updateCountryOptions();
          
          // Show success message for 2 seconds before redirect
          setTimeout(() => {
            window.location.href = '/representative/dashboard';
          }, 2000);
        } else {
          messageDiv.textContent = data.error || 'Registration failed';
          messageDiv.className = 'message error';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Register Team';
          
          // Refresh taken countries in case it changed
          await loadTakenCountries();
          updateCountryOptions();
          checkCountryAvailability();
        }
      } catch (error) {
        messageDiv.textContent = 'Registration failed. Please try again.';
        messageDiv.className = 'message error';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register Team';
        console.error('Error:', error);
        
        // Refresh taken countries in case of error
        await loadTakenCountries();
        updateCountryOptions();
        checkCountryAvailability();
      }
    });

    // Real-time country availability check
    let checkTimeout;
    document.getElementById('country').addEventListener('change', function() {
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(checkCountryAvailability, 300);
    });

    // Initialize on page load
    window.addEventListener('load', async () => {
      await loadTakenCountries();
      updateCountryOptions();
      checkCountryAvailability();
      
      // Auto-refresh country list every 30 seconds
      setInterval(async () => {
        await loadTakenCountries();
        updateCountryOptions();
        checkCountryAvailability();
      }, 30000);
    });

    // Form validation on input
    document.getElementById('email').addEventListener('blur', function() {
      const email = this.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (email && !emailRegex.test(email)) {
        this.style.borderColor = '#ff6b6b';
      } else {
        this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
      }
    });

    document.getElementById('password').addEventListener('blur', function() {
      const password = this.value;
      if (password && password.length < 6) {
        this.style.borderColor = '#ff6b6b';
      } else {
        this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
      }
    });
  </script>
</body>
</html>